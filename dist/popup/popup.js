(()=>{"use strict";var e;!function(e){e.DISCOVERED="discovered",e.ACTIVE="active",e.PAUSED="paused",e.COOLDOWN="cooldown",e.ERROR="error",e.REMOVED="removed"}(e||(e={}));const t={clickInterval:2,maxTabs:2,globalPaused:!1,loggingEnabled:!0,refreshInterval:10};function o(e){return{...e,interval:e.clickInterval}}const a="extension_settings",n="managed_tabs",s="activity_logs";async function r(e){try{console.log("üíæ STORAGE SAVE - Input settings:",e);const t=await l();console.log("üíæ STORAGE SAVE - Current settings from storage:",t);const n={...t,...e};console.log("üíæ STORAGE SAVE - Merged settings:",n);const s=o(n);console.log("üíæ STORAGE SAVE - Converted to storage format:",s),await chrome.storage.sync.set({[a]:s}),console.log("üíæ STORAGE SAVE - Successfully saved to Chrome Storage");const r=await chrome.storage.sync.get(a);console.log("üíæ STORAGE SAVE - Verification read from Chrome Storage:",r)}catch(e){throw console.error("‚ùå STORAGE SAVE - Failed:",e),new Error(`Storage save failed: ${e}`)}}async function l(){try{console.log("üì• STORAGE GET - Reading from Chrome Storage...");const n=await chrome.storage.sync.get(a);console.log("üì• STORAGE GET - Raw result from Chrome Storage:",n);const s=n[a];console.log("üì• STORAGE GET - Extracted stored settings:",s);const r=o(t);console.log("üì• STORAGE GET - Defaults in legacy format:",r);const l={...r,...s};console.log("üì• STORAGE GET - Merged legacy settings:",l);const c={clickInterval:(e=l).interval||e.clickInterval||t.clickInterval,maxTabs:e.maxTabs,globalPaused:e.globalPaused,loggingEnabled:e.loggingEnabled,refreshInterval:e.refreshInterval};console.log("üì• STORAGE GET - Converted to modern format:",c);const i=function(e){var o,a,n;return{clickInterval:(n=e.clickInterval,"number"==typeof n&&n>=1&&n<=600?e.clickInterval:t.clickInterval),maxTabs:(a=e.maxTabs,"number"==typeof a&&a>=1&&a<=5?e.maxTabs:t.maxTabs),globalPaused:"boolean"==typeof e.globalPaused?e.globalPaused:t.globalPaused,loggingEnabled:"boolean"==typeof e.loggingEnabled?e.loggingEnabled:t.loggingEnabled,refreshInterval:(o=e.refreshInterval,"number"==typeof o&&o>=1&&o<=600?e.refreshInterval:t.refreshInterval)}}(c);return console.log("üì• STORAGE GET - Final validated settings:",i),i}catch(e){console.error("‚ùå STORAGE GET - Failed:",e);const o={...t};return console.log("üì• STORAGE GET - Returning defaults due to error:",o),o}var e}async function c(e){await r({globalPaused:e})}async function i(){try{return(await chrome.storage.local.get(n))[n]||[]}catch(e){return console.error("Failed to get managed tabs:",e),[]}}const g=new class{constructor(){this.logs=[],this.maxLogs=500,this.storageKey="extension_error_logs"}async log(e,t,o,a){const n={timestamp:(new Date).toISOString(),level:e,component:t,message:o,data:a?JSON.stringify(a).substring(0,2e3):void 0};this.logs.push(n),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs));try{await chrome.storage.local.set({[this.storageKey]:this.logs})}catch(e){console.error("Failed to save logs to storage:",e)}const s=`[${e}] ${t}: ${o}`;switch(e){case"ERROR":case"CRITICAL":console.error(s,a);break;case"WARNING":console.warn(s,a);break;case"SUCCESS":console.log(s,a)}}async getLogs(){try{return(await chrome.storage.local.get([this.storageKey]))[this.storageKey]||[]}catch(e){return console.error("Failed to get logs from storage:",e),[]}}async clearLogs(){try{this.logs=[],await chrome.storage.local.remove([this.storageKey])}catch(e){console.error("Failed to clear logs:",e)}}async exportLogs(){return(await this.getLogs()).map((e=>`${e.timestamp} [${e.level}] ${e.component}: ${e.message}${e.data?` | Data: ${e.data}`:""}`)).join("\n")}async error(e,t,o){return this.log("ERROR",e,t,o)}async critical(e,t,o){return this.log("CRITICAL",e,t,o)}async success(e,t,o){return this.log("SUCCESS",e,t,o)}async warning(e,t,o){return this.log("WARNING",e,t,o)}};let d,u,m,b,f,v,E,S,T;console.log("üöÄ HeadHunter Resume Auto-Boost Extension: Popup script loaded"),console.log("üöÄ Current URL:",window.location.href),console.log("üöÄ Document ready state:",document.readyState);let h=[],p=!1;async function y(e,t=3,o=1e3){let a=null;for(let n=1;n<=t;n++)try{console.log(`üì§ Popup attempt ${n}/${t}: Sending message to Service Worker:`,e.type);const o=await chrome.runtime.sendMessage(e);if(o&&!1!==o.success)return console.log(`‚úÖ Message sent successfully to Service Worker on attempt ${n}`),o;throw new Error(o?.error||"Service Worker returned unsuccessful response")}catch(e){if(a=e,console.warn(`‚ö†Ô∏è Popup attempt ${n}/${t} failed:`,e),n===t)break;const s=o*Math.pow(2,n-1);console.log(`‚è≥ Popup waiting ${s}ms before retry ${n+1}...`),await new Promise((e=>setTimeout(e,s)))}throw console.error(`‚ùå Popup: All ${t} attempts failed. Last error:`,a),a||new Error(`Failed to send message to Service Worker after ${t} attempts`)}async function I(){try{console.log("üì• LOAD SETTINGS - Calling getSettings()..."),T=await l(),console.log("üì• LOAD SETTINGS - Received from storage:",T)}catch(e){console.error("‚ùå Failed to load settings:",e),T={clickInterval:15,maxTabs:2,refreshInterval:15,globalPaused:!1,loggingEnabled:!0},console.log("üì• LOAD SETTINGS - Using defaults:",T)}}async function w(){try{console.log("=== Loading Managed Tabs ===");const e=await y({type:"GET_EXTENSION_STATE"});console.log("Service Worker response:",e),e.success&&e.data.managedTabs?(console.log("Raw managedTabs from Service Worker:",e.data.managedTabs),h=e.data.managedTabs.map((e=>{const t={tabId:e.tabId,title:e.title,url:e.url,state:e.state,lastClickTime:e.lastClickTime,errorCount:e.errorCount||0,timerStatus:e.timerStatus,nextClickTime:e.timerStatus?.isActive?Date.now()+(e.timerStatus.remainingMs||0):null};return console.log("Converted tab:",{tabId:t.tabId,title:t.title,timerStatus:t.timerStatus}),t})),console.log("‚úÖ Managed tabs loaded with timer info:",h.length,"tabs")):(console.log("‚ùå Service Worker response failed, using storage fallback"),console.log("Response details:",{success:e.success,hasData:!!e.data,hasManagedTabs:!(!e.data||!e.data.managedTabs)}),h=await i(),console.log("Managed tabs loaded from storage (fallback):",h)),console.log("=== End Loading Managed Tabs ===")}catch(e){console.error("‚ùå Failed to load managed tabs:",e);try{h=await i(),console.log("Storage fallback successful:",h.length,"tabs")}catch(e){console.error("‚ùå Storage fallback also failed:",e),h=[]}}}async function A(){try{const e=await async function(){try{return(await chrome.storage.local.get(s))[s]||[]}catch(e){return console.error("Failed to get logs:",e),[]}}();return console.log("Logs loaded:",e.length,"entries"),e}catch(e){return console.error("Failed to load logs:",e),[]}}async function C(){try{p=!p,await c(p),T.globalPaused=p,await r(T);const e={type:"SET_GLOBAL_PAUSE",paused:p},t=await y(e);if(!t?.success)return console.error("Failed to set global pause in background script:",t),p=!p,void await c(p);N(),D(),console.log("Global pause toggled:",p)}catch(e){console.error("Failed to toggle global pause:",e),p=!p,N(),D()}}async function P(){try{console.log("üîç DIRECT CHROME STORAGE CHECK:");const e=await chrome.storage.sync.get();console.log("üîç ALL Chrome Storage data:",e);const t=await chrome.storage.sync.get("extension_settings");console.log("üîç Settings from Chrome Storage:",t)}catch(e){console.error("üîç Failed to check Chrome Storage:",e)}}async function O(e){try{console.log("üíæ UPDATE SETTINGS - Input updates:",e),console.log("üíæ UPDATE SETTINGS - Current settings before merge:",T),T={...T,...e},console.log("üíæ UPDATE SETTINGS - Settings after merge:",T),console.log("üíæ UPDATE SETTINGS - Calling saveSettings..."),await r(T),console.log("üíæ UPDATE SETTINGS - saveSettings completed");const t={type:"SETTINGS_UPDATE",data:T};console.log("üíæ UPDATE SETTINGS - Sending message to background:",t),y(t).catch((e=>{console.error("Failed to send settings update to Service Worker:",e)})),console.log("üíæ UPDATE SETTINGS - Reloading settings..."),await I(),console.log("üíæ UPDATE SETTINGS - Settings after reload:",T),await w(),x(),D(),console.log("üíæ UPDATE SETTINGS - Final settings:",T)}catch(e){console.error("‚ùå Failed to update settings:",e)}}async function R(){try{await async function(){try{await chrome.storage.local.set({[s]:[]})}catch(e){throw console.error("Failed to clear logs:",e),new Error(`Failed to clear logs: ${e}`)}}(),U(),console.log("Logs cleared")}catch(e){console.error("Failed to clear logs:",e)}}async function L(){try{const e=await g.exportLogs();if(!e.trim())return void alert("No logs to export");const t=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(t),a=document.createElement("a");a.href=o,a.download=`hh-extension-logs-${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),console.log("‚úÖ Logs exported successfully")}catch(e){console.error("‚ùå Failed to export logs:",e),alert("Failed to export logs")}}function k(e){switch(console.log("Received message from background:",e),e.type){case"TAB_UPDATE":w().then((()=>{x(),D()}));break;case"LOG_UPDATE":U();break;case"STATUS_UPDATE":D();break;default:console.log("Unknown message type:",e.type)}}function D(t,o){if(t&&o)return d.className=`status-dot ${t}`,void(u.textContent=o);p?(d.className="status-dot paused",u.textContent="Paused"):0===h.length?(d.className="status-dot",u.textContent="No tabs found"):h.some((t=>t.state===e.ERROR))?(d.className="status-dot error",u.textContent="Error detected"):h.some((t=>t.state===e.ACTIVE))?(d.className="status-dot active",u.textContent=`Active (${h.filter((t=>t.state===e.ACTIVE)).length} tabs)`):(d.className="status-dot",u.textContent="Inactive")}function N(){p?(f.textContent="‚ñ∂Ô∏è Resume All",f.className="btn btn-primary"):(f.textContent="‚è∏Ô∏è Pause All",f.className="btn btn-secondary")}function x(){if(0===h.length)return void(m.innerHTML='\n      <div style="text-align: center; padding: 20px; color: #6c757d;">\n        <p>No HeadHunter resume tabs found</p>\n        <p style="font-size: 11px; margin-top: 8px;">\n          Open your resume page on hh.ru or hh.kz to start auto-boosting\n        </p>\n      </div>\n    ');const t=h.map((t=>{const o=function(t){switch(t){case e.ACTIVE:return"state-active";case e.PAUSED:return"state-paused";case e.COOLDOWN:return"state-cooldown";case e.ERROR:return"state-error";default:return"state-inactive"}}(t.state),a=function(t){switch(t){case e.ACTIVE:return"Active";case e.PAUSED:return"Paused";case e.COOLDOWN:return"Cooldown";case e.ERROR:return"Error";case e.DISCOVERED:return"Discovered";case e.REMOVED:return"Removed";default:return"Unknown"}}(t.state),n=function(e){console.log("=== Timer Debug Info ==="),console.log("Tab:",{tabId:e.tabId,title:e.title,state:e.state});const t=h.find((t=>t.tabId===e.tabId));if(console.log("Found tabData:",t?"YES":"NO"),!t)return console.log("‚ùå No tabData found for tabId:",e.tabId),console.log("Available managedTabs:",h.map((e=>({tabId:e.tabId,title:e.title})))),"Not scheduled";if(console.log("TabData timerStatus:",t.timerStatus),!t.timerStatus)return console.log("‚ùå No timerStatus in tabData"),"Not scheduled";const o=t.timerStatus;if(console.log("Timer status details:",{exists:o.exists,isActive:o.isActive,remainingMs:o.remainingMs,remainingFormatted:o.remainingFormatted,alarmName:o.alarmName}),!o.exists)return console.log("‚ùå Timer does not exist"),"Not scheduled";if(!o.isActive)return console.log("‚ùå Timer is not active"),"Not scheduled";const a=o.remainingMs||0;if(console.log("Remaining milliseconds:",a),a<=0)return console.log("‚úÖ Timer ready (remaining <= 0)"),"Ready";const n=Math.ceil(a/1e3),s=Math.floor(n/60),r=n%60,l=s>0?`${s}m ${r}s`:`${r}s`;return console.log("‚úÖ Alarm timer result:",l),console.log("=== End Timer Debug ==="),l}(t),s=function(e){if(!e.lastClickTime)return"Never";const t=Date.now()-e.lastClickTime,o=Math.floor(t/6e4);return o<1?"Just now":o<60?`${o}m ago`:`${Math.floor(o/60)}h ago`}(t);return`\n      <div class="tab-item" data-tab-id="${t.tabId}">\n        <div class="tab-header">\n          <div class="tab-title" title="${t.url}">\n            ${r=t.title||t.url,r.length<=30?r:r.substring(0,27)+"..."}\n          </div>\n          <div class="tab-status ${o}">${a}</div>\n        </div>\n        <div class="tab-details">\n          <div class="tab-info">\n            <span class="info-label">Next click:</span>\n            <span class="info-value">${n}</span>\n          </div>\n          <div class="tab-info">\n            <span class="info-label">Last click:</span>\n            <span class="info-value">${s}</span>\n          </div>\n        </div>\n        <div class="tab-actions">\n          <button class="btn btn-small tab-pause-btn" data-tab-id="${t.tabId}">\n            ${t.state===e.PAUSED?"‚ñ∂Ô∏è Resume":"‚è∏Ô∏è Pause"}\n          </button>\n          <button class="btn btn-small tab-remove-btn" data-tab-id="${t.tabId}">\n            üóëÔ∏è Remove\n          </button>\n        </div>\n      </div>\n    `;var r})).join("");m.innerHTML=t,m.querySelectorAll(".tab-pause-btn").forEach((e=>{e.addEventListener("click",G)})),m.querySelectorAll(".tab-remove-btn").forEach((e=>{e.addEventListener("click",$)}))}async function G(t){const o=t.target,a=parseInt(o.dataset.tabId||"0",10);try{const t=h.find((e=>e.tabId===a));if(!t)return void console.error("Tab not found:",a);const o=!(t.state===e.PAUSED),n={type:"SET_TAB_PAUSE",tabId:a,paused:o},s=await y(n);s?.success?(console.log(`Tab ${o?"paused":"resumed"}:`,a),await w(),x()):console.error("Failed to toggle tab pause:",s)}catch(e){console.error("Failed to toggle tab pause:",e)}}async function $(e){const t=e.target,o=parseInt(t.dataset.tabId||"0",10);if(confirm("Remove this tab from auto-boosting?"))try{h=h.filter((e=>e.tabId!==o)),x(),D();const e={type:"TAB_REMOVE",tabId:o},t=await y(e);t?.success?console.log("Tab removed successfully:",o):(console.error("Failed to remove tab from background:",t),await w(),x())}catch(e){console.error("Failed to remove tab:",e),await w(),x()}}async function U(){try{const e=await A();if(0===e.length)return void(b.innerHTML='\n        <div style="text-align: center; padding: 20px; color: #6c757d;">\n          <p>No activity logs yet</p>\n        </div>\n      ');const t=e.slice(-10).reverse().map((e=>{const t=new Date(e.timestamp).toLocaleTimeString();return`\n        <div class="log-entry ${function(e){switch(e.toLowerCase()){case"error":return"log-error";case"warn":return"log-warn";case"info":return"log-info";default:return"log-debug"}}(e.level)}">\n          <div class="log-time">${t}</div>\n          <div class="log-message">${e.message}</div>\n        </div>\n      `})).join("");b.innerHTML=t}catch(e){console.error("Failed to render logs:",e),b.innerHTML='\n      <div style="text-align: center; padding: 20px; color: #dc3545;">\n        <p>Failed to load logs</p>\n      </div>\n    '}}console.log("üöÄ POPUP - Adding DOMContentLoaded listener..."),document.addEventListener("DOMContentLoaded",(()=>{console.log("üöÄ POPUP - DOMContentLoaded fired, calling initializePopup..."),async function(){try{if(console.log("üöÄ POPUP INIT - Starting initialization..."),console.log("üöÄ POPUP INIT - DOM ready state:",document.readyState),d=document.querySelector(".status-dot"),u=document.querySelector(".status-text"),m=document.querySelector(".tabs-list"),b=document.querySelector(".logs-list"),f=document.getElementById("global-pause"),v=document.getElementById("settings"),E=document.getElementById("clear-logs"),S=document.getElementById("export-logs"),console.log("üöÄ POPUP INIT - DOM elements found:",{statusDot:!!d,statusText:!!u,tabsList:!!m,logsList:!!b,globalPauseBtn:!!f,settingsBtn:!!v,clearLogsBtn:!!E,exportLogsBtn:!!S}),!(d&&u&&m&&b&&f&&v&&E&&S))throw console.error("üöÄ POPUP INIT - Missing DOM elements!"),new Error("Required DOM elements not found");await I(),await w(),await async function(){try{console.log("üì• LOAD GLOBAL PAUSE - Getting state from Service Worker...");const e=await y({type:"GET_EXTENSION_STATE"});e.success&&e.data?(p=e.data.globalPaused,console.log("üì• LOAD GLOBAL PAUSE - From Service Worker:",p)):(console.log("üì• LOAD GLOBAL PAUSE - Service Worker failed, using storage fallback"),p=await async function(){return(await l()).globalPaused}(),console.log("üì• LOAD GLOBAL PAUSE - From storage:",p)),N(),console.log("‚úÖ Global pause state loaded:",p)}catch(e){console.error("‚ùå Failed to load global pause state:",e),p=!1,N()}}(),await A(),f.addEventListener("click",C),v.addEventListener("click",(async()=>{await async function(){console.log("üîß SETTINGS CLICK - Current settings before reload:",T),await P(),await I(),console.log("üîß SETTINGS CLICK - Current settings after reload:",T);const e=`\nCurrent Settings:\n‚Ä¢ Click interval: ${T.clickInterval} minutes\n‚Ä¢ Page refresh interval: ${T.refreshInterval} minutes\n\nWhat would you like to change?\n1. Click interval (1-600 minutes)\n2. Page refresh interval (1-600 minutes)\n3. Cancel\n\nEnter 1, 2, or 3:`,t=prompt(e,"1");if(console.log("üîß User choice:",t),"1"===t){const e=prompt(`Current click interval: ${T.clickInterval} minutes\nEnter new interval (1-600 minutes):`,T.clickInterval.toString());if(console.log("üîß User entered new interval:",e),e){const t=parseInt(e,10);console.log("üîß Parsed interval:",t),t>=1&&t<=600?(console.log("üîß Calling updateSettings with clickInterval:",t),await async function(e){try{console.log("üß™ DIRECT SAVE TEST - Saving interval:",e),await chrome.storage.sync.set({test_interval:e,extension_settings:{clickInterval:e,maxTabs:2,globalPaused:!1,loggingEnabled:!0,refreshInterval:10}}),console.log("üß™ DIRECT SAVE TEST - Save completed");const t=await chrome.storage.sync.get(["test_interval","extension_settings"]);console.log("üß™ DIRECT SAVE TEST - Verification:",t)}catch(e){console.error("üß™ DIRECT SAVE TEST - Failed:",e)}}(t),await O({clickInterval:t}),console.log("üîß updateSettings completed, settings should be updated"),console.log("üîß Checking Chrome Storage after save:"),await P()):alert("Interval must be between 1 and 600 minutes")}}else if("2"===t){const e=prompt(`Current page refresh interval: ${T.refreshInterval} minutes\nEnter new interval (1-600 minutes):`,T.refreshInterval.toString());if(e){const t=parseInt(e,10);t>=1&&t<=600?await O({refreshInterval:t}):alert("Refresh interval must be between 1 and 600 minutes")}}}()})),E.addEventListener("click",R),S.addEventListener("click",L),chrome.runtime.onMessage.addListener(k),console.log("Event listeners set up"),function(){const e=document.querySelector(".version-info");if(e){const t=chrome.runtime.getManifest();e.textContent=`v${t.version} - Final Release ‚úÖ`,console.log("üìã Version updated to:",t.version)}}(),D(),x(),U(),console.log("üöÄ POPUP INIT - Popup interface initialized successfully")}catch(e){console.error("üöÄ POPUP INIT - Failed to initialize popup:",e),D("error","Initialization failed")}}()})),setInterval((()=>{w().then((()=>{x(),D()})),U()}),5e3)})();