(()=>{"use strict";var e;!function(e){e.DISCOVERED="discovered",e.ACTIVE="active",e.PAUSED="paused",e.COOLDOWN="cooldown",e.ERROR="error",e.REMOVED="removed"}(e||(e={}));const t={clickInterval:2,maxTabs:2,globalPaused:!1,loggingEnabled:!0,refreshInterval:10};function o(e){return{...e,interval:e.clickInterval}}const a="extension_settings",n="managed_tabs",s="activity_logs";async function r(e){try{console.log("üíæ STORAGE SAVE - Input settings:",e);const t=await l();console.log("üíæ STORAGE SAVE - Current settings from storage:",t);const n={...t,...e};console.log("üíæ STORAGE SAVE - Merged settings:",n);const s=o(n);console.log("üíæ STORAGE SAVE - Converted to storage format:",s),await chrome.storage.sync.set({[a]:s}),console.log("üíæ STORAGE SAVE - Successfully saved to Chrome Storage");const r=await chrome.storage.sync.get(a);console.log("üíæ STORAGE SAVE - Verification read from Chrome Storage:",r)}catch(e){throw console.error("‚ùå STORAGE SAVE - Failed:",e),new Error(`Storage save failed: ${e}`)}}async function l(){try{console.log("üì• STORAGE GET - Reading from Chrome Storage...");const n=await chrome.storage.sync.get(a);console.log("üì• STORAGE GET - Raw result from Chrome Storage:",n);const s=n[a];console.log("üì• STORAGE GET - Extracted stored settings:",s);const r=o(t);console.log("üì• STORAGE GET - Defaults in legacy format:",r);const l={...r,...s};console.log("üì• STORAGE GET - Merged legacy settings:",l);const c={clickInterval:(e=l).interval||e.clickInterval||t.clickInterval,maxTabs:e.maxTabs,globalPaused:e.globalPaused,loggingEnabled:e.loggingEnabled,refreshInterval:e.refreshInterval};console.log("üì• STORAGE GET - Converted to modern format:",c);const i=function(e){var o,a,n;return{clickInterval:(n=e.clickInterval,"number"==typeof n&&n>=1&&n<=600?e.clickInterval:t.clickInterval),maxTabs:(a=e.maxTabs,"number"==typeof a&&a>=1&&a<=5?e.maxTabs:t.maxTabs),globalPaused:"boolean"==typeof e.globalPaused?e.globalPaused:t.globalPaused,loggingEnabled:"boolean"==typeof e.loggingEnabled?e.loggingEnabled:t.loggingEnabled,refreshInterval:(o=e.refreshInterval,"number"==typeof o&&o>=1&&o<=600?e.refreshInterval:t.refreshInterval)}}(c);return console.log("üì• STORAGE GET - Final validated settings:",i),i}catch(e){console.error("‚ùå STORAGE GET - Failed:",e);const o={...t};return console.log("üì• STORAGE GET - Returning defaults due to error:",o),o}var e}async function c(e){await r({globalPaused:e})}async function i(){try{return(await chrome.storage.local.get(n))[n]||[]}catch(e){return console.error("Failed to get managed tabs:",e),[]}}let g,d,u,m,f,b,E,v;console.log("üöÄ HeadHunter Resume Auto-Boost Extension: Popup script loaded"),console.log("üöÄ Current URL:",window.location.href),console.log("üöÄ Document ready state:",document.readyState);let T=[],S=!1;async function p(e,t=3,o=1e3){let a=null;for(let n=1;n<=t;n++)try{console.log(`üì§ Popup attempt ${n}/${t}: Sending message to Service Worker:`,e.type);const o=await chrome.runtime.sendMessage(e);if(o&&!1!==o.success)return console.log(`‚úÖ Message sent successfully to Service Worker on attempt ${n}`),o;throw new Error(o?.error||"Service Worker returned unsuccessful response")}catch(e){if(a=e,console.warn(`‚ö†Ô∏è Popup attempt ${n}/${t} failed:`,e),n===t)break;const s=o*Math.pow(2,n-1);console.log(`‚è≥ Popup waiting ${s}ms before retry ${n+1}...`),await new Promise((e=>setTimeout(e,s)))}throw console.error(`‚ùå Popup: All ${t} attempts failed. Last error:`,a),a||new Error(`Failed to send message to Service Worker after ${t} attempts`)}async function h(){try{console.log("üì• LOAD SETTINGS - Calling getSettings()..."),v=await l(),console.log("üì• LOAD SETTINGS - Received from storage:",v)}catch(e){console.error("‚ùå Failed to load settings:",e),v={clickInterval:15,maxTabs:2,refreshInterval:15,globalPaused:!1,loggingEnabled:!0},console.log("üì• LOAD SETTINGS - Using defaults:",v)}}async function I(){try{console.log("=== Loading Managed Tabs ===");const e=await p({type:"GET_EXTENSION_STATE"});console.log("Service Worker response:",e),e.success&&e.data.managedTabs?(console.log("Raw managedTabs from Service Worker:",e.data.managedTabs),T=e.data.managedTabs.map((e=>{const t={tabId:e.tabId,title:e.title,url:e.url,state:e.state,lastClickTime:e.lastClickTime,errorCount:e.errorCount||0,timerStatus:e.timerStatus,nextClickTime:e.timerStatus?.isActive?Date.now()+(e.timerStatus.remainingMs||0):null};return console.log("Converted tab:",{tabId:t.tabId,title:t.title,timerStatus:t.timerStatus}),t})),console.log("‚úÖ Managed tabs loaded with timer info:",T.length,"tabs")):(console.log("‚ùå Service Worker response failed, using storage fallback"),console.log("Response details:",{success:e.success,hasData:!!e.data,hasManagedTabs:!(!e.data||!e.data.managedTabs)}),T=await i(),console.log("Managed tabs loaded from storage (fallback):",T)),console.log("=== End Loading Managed Tabs ===")}catch(e){console.error("‚ùå Failed to load managed tabs:",e);try{T=await i(),console.log("Storage fallback successful:",T.length,"tabs")}catch(e){console.error("‚ùå Storage fallback also failed:",e),T=[]}}}async function y(){try{const e=await async function(){try{return(await chrome.storage.local.get(s))[s]||[]}catch(e){return console.error("Failed to get logs:",e),[]}}();return console.log("Logs loaded:",e.length,"entries"),e}catch(e){return console.error("Failed to load logs:",e),[]}}async function A(){try{S=!S,await c(S),v.globalPaused=S,await r(v);const e={type:"SET_GLOBAL_PAUSE",paused:S},t=await p(e);if(!t?.success)return console.error("Failed to set global pause in background script:",t),S=!S,void await c(S);D(),k(),console.log("Global pause toggled:",S)}catch(e){console.error("Failed to toggle global pause:",e),S=!S,D(),k()}}async function w(){try{console.log("üîç DIRECT CHROME STORAGE CHECK:");const e=await chrome.storage.sync.get();console.log("üîç ALL Chrome Storage data:",e);const t=await chrome.storage.sync.get("extension_settings");console.log("üîç Settings from Chrome Storage:",t)}catch(e){console.error("üîç Failed to check Chrome Storage:",e)}}async function P(e){try{console.log("üíæ UPDATE SETTINGS - Input updates:",e),console.log("üíæ UPDATE SETTINGS - Current settings before merge:",v),v={...v,...e},console.log("üíæ UPDATE SETTINGS - Settings after merge:",v),console.log("üíæ UPDATE SETTINGS - Calling saveSettings..."),await r(v),console.log("üíæ UPDATE SETTINGS - saveSettings completed");const t={type:"SETTINGS_UPDATE",data:v};console.log("üíæ UPDATE SETTINGS - Sending message to background:",t),p(t).catch((e=>{console.error("Failed to send settings update to Service Worker:",e)})),console.log("üíæ UPDATE SETTINGS - Reloading settings..."),await h(),console.log("üíæ UPDATE SETTINGS - Settings after reload:",v),await I(),R(),k(),console.log("üíæ UPDATE SETTINGS - Final settings:",v)}catch(e){console.error("‚ùå Failed to update settings:",e)}}async function C(){try{await async function(){try{await chrome.storage.local.set({[s]:[]})}catch(e){throw console.error("Failed to clear logs:",e),new Error(`Failed to clear logs: ${e}`)}}(),N(),console.log("Logs cleared")}catch(e){console.error("Failed to clear logs:",e)}}function O(e){switch(console.log("Received message from background:",e),e.type){case"TAB_UPDATE":I().then((()=>{R(),k()}));break;case"LOG_UPDATE":N();break;case"STATUS_UPDATE":k();break;default:console.log("Unknown message type:",e.type)}}function k(t,o){if(t&&o)return g.className=`status-dot ${t}`,void(d.textContent=o);S?(g.className="status-dot paused",d.textContent="Paused"):0===T.length?(g.className="status-dot",d.textContent="No tabs found"):T.some((t=>t.state===e.ERROR))?(g.className="status-dot error",d.textContent="Error detected"):T.some((t=>t.state===e.ACTIVE))?(g.className="status-dot active",d.textContent=`Active (${T.filter((t=>t.state===e.ACTIVE)).length} tabs)`):(g.className="status-dot",d.textContent="Inactive")}function D(){S?(f.textContent="‚ñ∂Ô∏è Resume All",f.className="btn btn-primary"):(f.textContent="‚è∏Ô∏è Pause All",f.className="btn btn-secondary")}function R(){if(0===T.length)return void(u.innerHTML='\n      <div style="text-align: center; padding: 20px; color: #6c757d;">\n        <p>No HeadHunter resume tabs found</p>\n        <p style="font-size: 11px; margin-top: 8px;">\n          Open your resume page on hh.ru or hh.kz to start auto-boosting\n        </p>\n      </div>\n    ');const t=T.map((t=>{const o=function(t){switch(t){case e.ACTIVE:return"state-active";case e.PAUSED:return"state-paused";case e.COOLDOWN:return"state-cooldown";case e.ERROR:return"state-error";default:return"state-inactive"}}(t.state),a=function(t){switch(t){case e.ACTIVE:return"Active";case e.PAUSED:return"Paused";case e.COOLDOWN:return"Cooldown";case e.ERROR:return"Error";case e.DISCOVERED:return"Discovered";case e.REMOVED:return"Removed";default:return"Unknown"}}(t.state),n=function(e){console.log("=== Timer Debug Info ==="),console.log("Tab:",{tabId:e.tabId,title:e.title,state:e.state});const t=T.find((t=>t.tabId===e.tabId));if(console.log("Found tabData:",t?"YES":"NO"),!t)return console.log("‚ùå No tabData found for tabId:",e.tabId),console.log("Available managedTabs:",T.map((e=>({tabId:e.tabId,title:e.title})))),"Not scheduled";if(console.log("TabData timerStatus:",t.timerStatus),!t.timerStatus)return console.log("‚ùå No timerStatus in tabData"),"Not scheduled";const o=t.timerStatus;if(console.log("Timer status details:",{exists:o.exists,isActive:o.isActive,remainingMs:o.remainingMs,remainingFormatted:o.remainingFormatted,alarmName:o.alarmName}),!o.exists)return console.log("‚ùå Timer does not exist"),"Not scheduled";if(!o.isActive)return console.log("‚ùå Timer is not active"),"Not scheduled";const a=o.remainingMs||0;if(console.log("Remaining milliseconds:",a),a<=0)return console.log("‚úÖ Timer ready (remaining <= 0)"),"Ready";const n=Math.ceil(a/1e3),s=Math.floor(n/60),r=n%60,l=s>0?`${s}m ${r}s`:`${r}s`;return console.log("‚úÖ Alarm timer result:",l),console.log("=== End Timer Debug ==="),l}(t),s=function(e){if(!e.lastClickTime)return"Never";const t=Date.now()-e.lastClickTime,o=Math.floor(t/6e4);return o<1?"Just now":o<60?`${o}m ago`:`${Math.floor(o/60)}h ago`}(t);return`\n      <div class="tab-item" data-tab-id="${t.tabId}">\n        <div class="tab-header">\n          <div class="tab-title" title="${t.url}">\n            ${r=t.title||t.url,r.length<=30?r:r.substring(0,27)+"..."}\n          </div>\n          <div class="tab-status ${o}">${a}</div>\n        </div>\n        <div class="tab-details">\n          <div class="tab-info">\n            <span class="info-label">Next click:</span>\n            <span class="info-value">${n}</span>\n          </div>\n          <div class="tab-info">\n            <span class="info-label">Last click:</span>\n            <span class="info-value">${s}</span>\n          </div>\n        </div>\n        <div class="tab-actions">\n          <button class="btn btn-small tab-pause-btn" data-tab-id="${t.tabId}">\n            ${t.state===e.PAUSED?"‚ñ∂Ô∏è Resume":"‚è∏Ô∏è Pause"}\n          </button>\n          <button class="btn btn-small tab-remove-btn" data-tab-id="${t.tabId}">\n            üóëÔ∏è Remove\n          </button>\n        </div>\n      </div>\n    `;var r})).join("");u.innerHTML=t,u.querySelectorAll(".tab-pause-btn").forEach((e=>{e.addEventListener("click",G)})),u.querySelectorAll(".tab-remove-btn").forEach((e=>{e.addEventListener("click",L)}))}async function G(t){const o=t.target,a=parseInt(o.dataset.tabId||"0",10);try{const t=T.find((e=>e.tabId===a));if(!t)return void console.error("Tab not found:",a);const o=!(t.state===e.PAUSED),n={type:"SET_TAB_PAUSE",tabId:a,paused:o},s=await p(n);s?.success?(console.log(`Tab ${o?"paused":"resumed"}:`,a),await I(),R()):console.error("Failed to toggle tab pause:",s)}catch(e){console.error("Failed to toggle tab pause:",e)}}async function L(e){const t=e.target,o=parseInt(t.dataset.tabId||"0",10);if(confirm("Remove this tab from auto-boosting?"))try{T=T.filter((e=>e.tabId!==o)),R(),k();const e={type:"TAB_REMOVE",tabId:o},t=await p(e);t?.success?console.log("Tab removed successfully:",o):(console.error("Failed to remove tab from background:",t),await I(),R())}catch(e){console.error("Failed to remove tab:",e),await I(),R()}}async function N(){try{const e=await y();if(0===e.length)return void(m.innerHTML='\n        <div style="text-align: center; padding: 20px; color: #6c757d;">\n          <p>No activity logs yet</p>\n        </div>\n      ');const t=e.slice(-10).reverse().map((e=>{const t=new Date(e.timestamp).toLocaleTimeString();return`\n        <div class="log-entry ${function(e){switch(e.toLowerCase()){case"error":return"log-error";case"warn":return"log-warn";case"info":return"log-info";default:return"log-debug"}}(e.level)}">\n          <div class="log-time">${t}</div>\n          <div class="log-message">${e.message}</div>\n        </div>\n      `})).join("");m.innerHTML=t}catch(e){console.error("Failed to render logs:",e),m.innerHTML='\n      <div style="text-align: center; padding: 20px; color: #dc3545;">\n        <p>Failed to load logs</p>\n      </div>\n    '}}console.log("üöÄ POPUP - Adding DOMContentLoaded listener..."),document.addEventListener("DOMContentLoaded",(()=>{console.log("üöÄ POPUP - DOMContentLoaded fired, calling initializePopup..."),async function(){try{if(console.log("üöÄ POPUP INIT - Starting initialization..."),console.log("üöÄ POPUP INIT - DOM ready state:",document.readyState),g=document.querySelector(".status-dot"),d=document.querySelector(".status-text"),u=document.querySelector(".tabs-list"),m=document.querySelector(".logs-list"),f=document.getElementById("global-pause"),b=document.getElementById("settings"),E=document.getElementById("clear-logs"),console.log("üöÄ POPUP INIT - DOM elements found:",{statusDot:!!g,statusText:!!d,tabsList:!!u,logsList:!!m,globalPauseBtn:!!f,settingsBtn:!!b,clearLogsBtn:!!E}),!(g&&d&&u&&m&&f&&b&&E))throw console.error("üöÄ POPUP INIT - Missing DOM elements!"),new Error("Required DOM elements not found");await h(),await I(),await async function(){try{console.log("üì• LOAD GLOBAL PAUSE - Getting state from Service Worker...");const e=await p({type:"GET_EXTENSION_STATE"});e.success&&e.data?(S=e.data.globalPaused,console.log("üì• LOAD GLOBAL PAUSE - From Service Worker:",S)):(console.log("üì• LOAD GLOBAL PAUSE - Service Worker failed, using storage fallback"),S=await async function(){return(await l()).globalPaused}(),console.log("üì• LOAD GLOBAL PAUSE - From storage:",S)),D(),console.log("‚úÖ Global pause state loaded:",S)}catch(e){console.error("‚ùå Failed to load global pause state:",e),S=!1,D()}}(),await y(),f.addEventListener("click",A),b.addEventListener("click",(async()=>{await async function(){console.log("üîß SETTINGS CLICK - Current settings before reload:",v),await w(),await h(),console.log("üîß SETTINGS CLICK - Current settings after reload:",v);const e=`\nCurrent Settings:\n‚Ä¢ Click interval: ${v.clickInterval} minutes\n‚Ä¢ Page refresh interval: ${v.refreshInterval} minutes\n\nWhat would you like to change?\n1. Click interval (1-600 minutes)\n2. Page refresh interval (1-600 minutes)\n3. Cancel\n\nEnter 1, 2, or 3:`,t=prompt(e,"1");if(console.log("üîß User choice:",t),"1"===t){const e=prompt(`Current click interval: ${v.clickInterval} minutes\nEnter new interval (1-600 minutes):`,v.clickInterval.toString());if(console.log("üîß User entered new interval:",e),e){const t=parseInt(e,10);console.log("üîß Parsed interval:",t),t>=1&&t<=600?(console.log("üîß Calling updateSettings with clickInterval:",t),await async function(e){try{console.log("üß™ DIRECT SAVE TEST - Saving interval:",e),await chrome.storage.sync.set({test_interval:e,extension_settings:{clickInterval:e,maxTabs:2,globalPaused:!1,loggingEnabled:!0,refreshInterval:10}}),console.log("üß™ DIRECT SAVE TEST - Save completed");const t=await chrome.storage.sync.get(["test_interval","extension_settings"]);console.log("üß™ DIRECT SAVE TEST - Verification:",t)}catch(e){console.error("üß™ DIRECT SAVE TEST - Failed:",e)}}(t),await P({clickInterval:t}),console.log("üîß updateSettings completed, settings should be updated"),console.log("üîß Checking Chrome Storage after save:"),await w()):alert("Interval must be between 1 and 600 minutes")}}else if("2"===t){const e=prompt(`Current page refresh interval: ${v.refreshInterval} minutes\nEnter new interval (1-600 minutes):`,v.refreshInterval.toString());if(e){const t=parseInt(e,10);t>=1&&t<=600?await P({refreshInterval:t}):alert("Refresh interval must be between 1 and 600 minutes")}}}()})),E.addEventListener("click",C),chrome.runtime.onMessage.addListener(O),console.log("Event listeners set up"),function(){const e=document.querySelector(".version-info");if(e){const t=chrome.runtime.getManifest();e.textContent=`v${t.version} - Final Release ‚úÖ`,console.log("üìã Version updated to:",t.version)}}(),k(),R(),N(),console.log("üöÄ POPUP INIT - Popup interface initialized successfully")}catch(e){console.error("üöÄ POPUP INIT - Failed to initialize popup:",e),k("error","Initialization failed")}}()})),setInterval((()=>{I().then((()=>{R(),k()})),N()}),5e3)})();